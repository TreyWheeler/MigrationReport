# SOP-Update Report

Use this SOP whenever you revise the alignment scores or narrative for an existing country or city report under `reports/`. It assumes no new evaluation keys are being added. Pair it with task-specific SOPs (for example, adding a brand-new key) when those flows tell you to "update existing reports."

## 0. Gather Core References
1. Open `family_profile.json` to anchor every judgement in the household's priorities and weighting (`evaluation_weights_0_to_5`).
2. Review `data/DATA_DICTIONARY.md` to confirm how categories, keys, and reports relate.
3. Load the authoritative lookup data with the PowerShell helpers instead of hand-parsing JSON:
   - `pwsh scripts/powershell/Categories_GET.ps1 -AsJson`
   - `pwsh scripts/powershell/CategoryKeys_GET.ps1 -AsJson`
   - `pwsh scripts/powershell/Countries_GET.ps1 -AsJson` and, if applicable, `pwsh scripts/powershell/Cities_GET.ps1 -CountryIds '<countryId>' -AsJson`
4. Open the target report file (e.g., `reports/portugal_report.json`). If you are updating a city, also open the parent country report so you can mirror tone and inheritance logic.

> Do not begin editing until these four data sources are in front of you - they contain everything needed for a quality update.

## 1. Build a Review Checklist
1. Create a quick worksheet (mental or written) that lists every `key` from `data/category_keys.json`, grouped by category.
2. Record the existing `alignmentValue`, `alignmentText`, and any `sameAsParent` flags from the report.
3. Highlight entries where the justification already seems misaligned with the rating guide or family priorities.

## 2. Regenerate Draft Suggestions with the Console App
1. Ensure the CLI has OpenAI credentials:
   - Set `DOTNET_ENVIRONMENT=Development` (export it if your shell does not inherit machine-level settings).
   - Export `REPORT_MAINTENANCE_OPENAI__APIKEY` when the dev appsettings file is not available in your session.
2. From the repo root run one of the commands below:
   - Entire report: `dotnet run --project tools/ReportMaintenance/ReportMaintenance.Cli -- UpdateReport --report <slug>`
   - Scope to a category or single key: append `--category "<category id or key name>"`
3. Let the command finish - it can take several minutes for a full report. Watch for failures in the console output; rerun the command after resolving any missing data or throttling issues.

## 3. Evaluate and Refine the Output
1. Review the updated JSON. For each key in your checklist, compare the new `alignmentValue` and `alignmentText` against rating guides, evidence, and family priorities.
2. Adjust scores or text that need nuance, clarity, or sourcing. The CLI provides a draft - your judgement ensures accuracy.
3. For city reports, decide where `"sameAsParent": true` should replace duplicated narratives.
4. Document unresolved data gaps in your worksheet so follow-up work is obvious.

## 4. Quality-Control Pass
1. Reread the entire report to ensure the tone is evidence-driven and tailored to the family profile.
2. Double-check that each score is compatible with its rating-guide description.
3. Validate JSON structure by running `node -e "JSON.parse(fs.readFileSync('reports/<file>.json','utf8'))"` on the updated report.
4. When updating a city, confirm any `sameAsParent` keys still reflect the current country scores.

## 5. Prepare for Commit
1. Review your diff to ensure only the intended fields changed.
2. Summarize major score shifts and any data gaps in your commit message or PR description.
3. If additional SOPs triggered this update (e.g., adding a new key), return to them and continue the remaining steps.
