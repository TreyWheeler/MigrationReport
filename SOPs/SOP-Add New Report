# SOP-Add New Report

Use this SOP when you need to create a brand-new country or city report under `reports/`. If you are refreshing an existing report, follow the [SOP-Update Report](SOP-Update%20Report) instead.

## 0. Align on Purpose and Scope
1. Read `family_profile.json` to understand the household's priorities, deal-breakers, and weighting (`evaluation_weights_0_to_5`).
2. Review `data/DATA_DICTIONARY.md` to confirm how countries, cities, categories, and keys connect.
3. Load reference data with the PowerShell helpers:
   - `pwsh scripts/powershell/Categories_GET.ps1 -AsJson`
   - `pwsh scripts/powershell/CategoryKeys_GET.ps1 -AsJson`
   - `pwsh scripts/powershell/Countries_GET.ps1 -AsJson`
   - `pwsh scripts/powershell/Cities_GET.ps1 -AsJson`
4. Identify whether you are creating a country report or a city report (with a parent `countryId`). Note the canonical `id` from the GET outputs.

## 1. Prepare Metadata Records
1. Confirm the country or city already exists in the relational tables. If not, insert it:
   - Countries: `pwsh scripts/powershell/Countries_INSERT.ps1 -Records @(@{ id = '<countryId>'; name = '<Display Name>'; report = 'reports/<file>.json' })`
   - Cities: `pwsh scripts/powershell/Cities_INSERT.ps1 -Records @(@{ id = '<cityId>'; countryId = '<countryId>'; name = '<Display Name>'; report = 'reports/<country>_<city>_report.json' })`
2. When linking a new city, double-check that the parent country already references the correct report path. Use `*_UPDATE.ps1` variants if you need to adjust existing records instead of editing JSON manually.

## 2. Generate the Report with the Console App
1. Confirm the CLI can reach OpenAI:
   - Set `DOTNET_ENVIRONMENT=Development` (machine-level `setx` is already in place, but export it if your shell does not inherit the value).
   - Export `REPORT_MAINTENANCE_OPENAI__APIKEY` when the dev appsettings file is not available in your session.
2. From the repo root run one of the commands below. Each scaffolds the JSON file and immediately calls `UpdateReport` to populate every key via OpenAI:
   - Country: `dotnet run --project tools/ReportMaintenance/ReportMaintenance.Cli -- AddCountry --country "<Display Name>" --iso "<ISO>"`
   - City: `dotnet run --project tools/ReportMaintenance/ReportMaintenance.Cli -- AddCity --country "<Country Name>" --city "<City Name>" [--iso "<ISO>" if the parent country report does not yet exist]`
3. Monitor the console output. The request batch can take several minutes; ensure the command finishes without errors before continuing.

## 3. Review and Refine the Generated Content
1. Open the new report file and confirm it includes `version`, `iso`, and a `values` entry for every key in `data/category_keys.json`.
2. Spot-check multiple keys against rating guides and your evidence sources. Edit any `alignmentValue`, `alignmentText`, or `sameAsParent` fields that need tuning.
3. For city reports, set `"sameAsParent": true` wherever the country narrative should be inherited and trim redundant copy.
4. If OpenAI skipped keys or produced placeholders, rerun `dotnet run --project tools/ReportMaintenance/ReportMaintenance.Cli -- UpdateReport --report <slug>` after addressing the issue.

## 4. Validate the Result
1. Confirm the `values` array contains every key exactly once (except entries that intentionally use `sameAsParent`).
2. Run `node -e "JSON.parse(fs.readFileSync('reports/<file>.json','utf8'))"` to verify JSON validity.
3. Reread the entire report to ensure the tone is evidence-driven and aligned with the family profile and rating guides.

## 5. Finalize and Document
1. Re-run the relevant `*_GET.ps1` scripts to confirm the new report path is registered in the relational tables.
2. Review your diff to ensure only the new report file and related metadata records were added or changed.
3. Summarize the location, key evidence sources, and any data gaps in your commit message or PR description.

> After completing this SOP, maintain the report using the [SOP-Update Report](SOP-Update%20Report) whenever new data arrives or rating guides change.
